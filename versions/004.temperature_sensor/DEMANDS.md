# 需求文档 - 温度传感器功能（v004）

## 目标
引入 DS18B20 数字温度传感器用于检测设备温度；温度状态并入电源管理 BLE Characteristic（0xFFF5）；新增温度阈值控制：超温时关断全部 PWM 并进入错误状态，降温至恢复阈值后自动恢复。

## 宿主硬件与引脚
- 传感器：DS18B20（单总线）
- 引脚连接（见 AGENTS.md 硬件定义）：
  - VDD：GPIO11
  - DQ：GPIO12
  - GND：GPIO13
- 供电与时序安全：
  - 上电复位、下电、进入/退出深度睡眠全过程保持传感器禁用（GPIO11/12/13 高阻或安全电平），避免极性错误/反向供电
  - 正常工作期间传感器持续上电：GPIO13=LOW，GPIO11=HIGH；DQ 由 One-Wire 驱动管理；非采样期不进行断电节能

## 功能需求
### 1. 初始化与稳态
- 系统启动后自动进行 One-Wire 初始化、设备存在检测与 CRC 校验；异常采用指数退避重试（最大 30s 间隔）
- 深度睡眠前自动关断并置高阻；唤醒后重新初始化并完成一次采样，然后保持持续上电
- 不提供“用户禁用温度传感器”的功能

### 2. 温度采样
- 采样周期固定为 1000ms（不支持配置）
- 分辨率：12-bit；对外以 0.01℃ 有符号整数表示（-32768~32767 → -327.68~327.67℃）
- 流程：触发转换 → 等待完成 → 读取并 CRC 校验 → 更新最新值与时间戳；错误时不更新数值，仅更新错误码与时间戳

### 3. 温度阈值与系统保护
- 高温阈值与恢复阈值（单位 0.01℃），默认：高温 6000=60.00℃，恢复 5500=55.00℃
- 去抖固定为 3 次（不支持配置）；迟滞按阈值差实现
- 行为：
  - 触发高温：
    - 立即关断 CH1~CH4 所有 PWM 通道（无论模式）
    - 保存“关断前的通道运行态快照”，用于后续恢复，包含：
      - 每路通道的当前模式（开关/固定值/PWM/渐变/等速闪烁/爆闪等）
      - 各模式的参数（目标值、周期、次数、总时长、停顿时长等）
    - 不保存运行进度/剩余时间/定时器位置
    - 系统状态置为“错误状态/热保护中”
  - 符合恢复阈值：
    - 系统退出错误状态
    - 按保存的快照恢复每路通道，仅恢复模式与参数，不保留进度；各模式按其初始状态重新开始
    - 快照在下一次超温触发前保持或更新
- BLE 通知：订阅后固定每 1000ms 发送一帧状态

### 4. BLE 接口（并入 0xFFF5）
- 兼容既有 0xFFF5 命令：保留电压阈值与睡眠控制（0x01..0x04）
- READ：返回电源与温度扩展状态（共 12 字节）：
  - uint16 电压（mV）
  - int16 温度（0.01℃）
  - int16 高温阈值（0.01℃）
  - int16 恢复阈值（0.01℃）
  - uint8 状态标志 bit0:热保护中 bit1:最近一次温度有效 bit2:保留 bit3:处于深睡眠策略中 其余保留
  - uint8 保留
- WRITE 新增命令：
  - 0x11 设置高温阈值（参数：int16 0.01℃）
  - 0x12 设置恢复阈值（参数：int16 0.01℃）
- NOTIFY：在已订阅时固定每 1000ms 发送；负载同 READ 前 4 字段（电压、温度、高温阈值、恢复阈值）

### 5. 持久化
- 使用 NVS 保存：高温阈值、恢复阈值
- 上电读取并应用；非法值采用默认并回写纠正

### 6. 与现有系统集成
- 调度：集成至 scheduler，每 1000ms 运行
- 电源管理：与 v003 电压策略并存；深睡前关断、唤醒后恢复并完成一次采样后常供电
- PWM 管理：热保护触发时统一关断并记录“通道运行态快照”；恢复时按快照回放（不保留进度）
- LED 状态：可选在热保护中以特定模式提示（不影响现有 LED 用法）
- 不影响既有 BLE 与控制功能；异常不导致系统重启

## 非功能需求
- 精度：满足 DS18B20 典型精度（±0.5℃ @ -10~85℃），系统端到端误差≤±0.5℃
- 时延：采样更新延迟 ≤ 1.5s
- 可靠性：连续运行 7×24h 无内存泄漏；异常自恢复
- 功耗：传感器在正常工作期间持续上电；深睡期间断电

## 默认配置
- 采样周期：1000ms（固定）
- 高温阈值：60.00℃
- 恢复阈值：55.00℃

## 测试清单
- 基本：周期采样、越界/恢复
- 保护：
  - 超温关断/恢复并校验“通道运行态”准确恢复（模式与参数），不要求进度连续
  - 与电压策略并发时热保护优先；恢复后策略不冲突
- BLE：0xFFF5 READ/WRITE/NOTIFY 扩展验证与兼容性；每秒通知频率与丢包容错
- 可靠性：长时间运行、多次睡眠/唤醒、异常注入（CRC 错误/设备缺失）