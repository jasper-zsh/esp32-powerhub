# 版本006 - 硬件定义更新需求文档

## 项目背景
基于ESP32S3的电源管理器项目，需要对现有系统进行适配更新，以反映最新的硬件定义变更。

## 核心需求

### 1. 外设电源管理
- **需求描述**: 实现外设电源的集中控制
- **具体要求**:
  - GPIO1控制所有外设电源
  - 系统唤醒时首先设置GPIO1为高电平，使所有外设上电
  - 系统睡眠前设置GPIO1为低电平，节省功耗
  - 确保外设电源时序正确，避免设备工作异常

### 2. ADC128S102外置ADC集成
- **需求描述**: 集成通过SPI连接的ADC128S102外置ADC芯片
- **具体要求**:
  - SPI接口连接：GPIO3(CS), GPIO4(SCLK), GPIO5(MISO), GPIO6(MOSI)
  - 支持读取8个通道的模拟数据
  - IN0通道连接ACS758，用于读取总输入电流
  - IN1~IN6通道连接ACS712，用于读取CH1~CH6的输出电流
  - 定期采样并提供电流数据给上层应用

### 3. 6通道PWM控制系统
- **需求描述**: 实现6个独立的PWM输出通道，支持多种控制模式
- **具体要求**:
  - PWM通道分别使用GPIO8/9/10/11/12/13
  - 支持多种控制模式：
    - **开关模式**:
      - 值=0：高阻态（GPIO输入模式，PWM输出关闭）
      - 值=255：恒定高电平输出
    - **PWM模式**:
      - 值=1~254：PWM输出，占空比 = value/255
    - **渐变模式**:
      - 支持在指定时间内从当前值渐变到目标值
      - 渐变时间可配置（毫秒）
    - **闪烁模式**:
      - 在0和最后一个非零值之间周期性切换
      - 可配置闪烁周期（总开+关时间）
    - **频闪模式**:
      - 支持指定次数的脉冲爆发
      - 可配置脉冲持续时间、爆发间隔
      - 支持50%占空比的脉冲输出
  - 每个通道可独立配置和控制
  - 支持实时停止正在进行的模式
  - 保持状态持久化，支持系统重启后恢复配置

### 4. 电源电压监测
- **需求描述**: 实现系统电源电压的实时监测
- **具体要求**:
  - 使用GPIO1通过分压电阻(240k:910k)读取电源电压
  - 配置ADC读取GPIO1的模拟值
  - 将模拟值转换为实际电压值
  - 提供电压阈值保护功能

### 5. 温度监测系统
- **需求描述**: 实现双区域温度监测
- **具体要求**:
  - 在GPIO7上连接两个DS18B20温度传感器
  - 一个用于电源区域温度监测
  - 一个用于控制区域温度监测
  - 实现温度数据采集和异常保护

### 6. RGB LED指示
- **需求描述**: 使用WS2812 RGB LED提供状态指示
- **具体要求**:
  - GPIO21连接WS2812 LED
  - 支持多种颜色显示不同系统状态
  - 可通过BLE配置LED显示模式

### 7. 通信协议优化
- **需求描述**: 基于新硬件定义优化通信协议
- **具体要求**:
  - 不需要保持对旧通讯协议的兼容性
  - 重新设计BLE服务特征以适配新的硬件功能
  - 优化数据传输效率
  - 提供完整的设备状态查询接口

## 技术约束
- 基于ESP-IDF框架开发
- 使用ESP32S3芯片资源
- 保持低功耗设计原则
- 确保系统稳定性和可靠性

## 验收标准
1. 所有硬件功能正常工作
2. 系统可正常构建和烧录
3. BLE通信功能完整
4. 功耗管理有效
5. 异常保护机制可靠