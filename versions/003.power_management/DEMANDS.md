# 需求文档 - 电源管理功能（v003）

## 目标
实现电源电压监测和深度睡眠功能，在电源电压低于阈值时自动进入深度睡眠，在电源电压高于阈值时自动唤醒，以保护电池和延长设备寿命。

## 硬件资源
- ADC 通道：GPIO2 连接分压电阻（对地 240KΩ，对电源 910KΩ），用于监测电源电压
- 深度睡眠：ESP32S3 的深度睡眠模式，支持 RTC 唤醒和外部唤醒
- 分压比计算：分压系数 = 240KΩ / (910KΩ + 240KΩ) = 0.2087
- ADC 转换关系：实际电源电压 = ADC读数 * (3.3V / 4095) / 0.2087

## 功能要求

### 1. 电压监测
- 使用 ADC1 通道（GPIO2）监测电源电压
- 配置合适的分压电阻参数（如 100kΩ:33kΩ）
- 提供电压校准功能，支持设置电压转换系数
- 实时监测电压，采样频率：1Hz

### 2. 阈值管理
- 可配置的睡眠阈值电压（默认：12.5V）
- 可配置的唤醒阈值电压（默认：13.0V）
- 支持 hysteresis（迟滞）设计：
  - 睡眠操作仅在电压持续低于睡眠阈值（12.5V）时触发
  - 唤醒操作仅在电压持续高于唤醒阈值（13.0V）时触发
  - 电压在12.5V-13.0V之间时保持当前状态不变
  - 防止电源电压在阈值附近波动时的频繁睡眠/唤醒切换
  - 增加去抖动机制：需要连续N次采样确认状态变化（默认：3次采样，即3秒）
- 阈值可通过 BLE 配置和查询

### 3. 深度睡眠控制
- 当电压低于睡眠阈值时，自动进入深度睡眠模式
- 进入睡眠前保存当前状态到 RTC 内存
- 支持 RTC 定时唤醒（如每 30 秒唤醒检查电压）
- 支持外部唤醒（如按键唤醒）

### 4. 唤醒机制
- 当电压高于唤醒阈值时，保持正常运行
- RTC 定时唤醒后检查电压，决定是否继续睡眠
- 唤醒后恢复保存的状态

### 5. BLE 接口扩展
- 新增电源管理 Characteristic（0xFFF5）：
  - READ：返回当前电压（2字节，单位 mV）
  - WRITE：设置阈值配置（格式：1字节命令 + 2字节参数）
- 命令格式：
  - 0x01：设置睡眠阈值（参数：阈值电压 mV）
  - 0x02：设置唤醒阈值（参数：阈值电压 mV）
  - 0x03：强制进入睡眠
  - 0x04：强制唤醒

## 非功能要求
- 电压监测精度：±50mV
- 响应时间：电压变化检测 < 2秒
- 睡眠模式功耗：< 10μA
- 不影响现有 BLE 和控制功能
- 状态保存和恢复要可靠