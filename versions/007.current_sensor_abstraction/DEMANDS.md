# 版本007 - 电流传感器抽象需求

## 背景
- 目前`main/adc128s102.c`以C函数形式直接驱动ADC128S102并计算电流，调用点散落在`system_monitor.c`、`main.c`等模块，难以替换或扩展。
- 项目已存在两套读取ADC的实现代码（硬件实机驱动与另一套备用/测试代码），但尚未通过统一接口进行隔离。
- 新硬件版本可能增减电流传感器数量，需要接口能够自动感知或灵活配置可用通道数量。

## 需求
1. **C++抽象层**  
   - 使用C++封装电流传感器（current sensing）逻辑，提供面向对象接口，统一暴露初始化、采样、数据缓存、校准等能力。  
   - 新接口需被现有C模块方便地调用，可通过`extern "C"`包裹或桥接函数形式暴露。

2. **自适应传感器数量**  
   - 抽象层需要支持不同数量的传感器（总电流 + N个通道电流），能够根据硬件定义或**编译期配置**决定有效通道并跳过未装载传感器。  
   - 返回的数据结构需包含：总电流（如存在）、各通道电流数组以及时间戳或状态，用于替代当前`current_sensor_data_t`。  
   - 当某一通道没有传感器或读取失败时，要能区分具体状态并允许上层采取降级处理。

3. **两套ADC实现映射为两个C++类**  
   - 需要把当前代码库中存在的两套ADC读取逻辑分别转换为独立的C++类，并实现共同接口以供抽象层选择。  
   - 明确两套实现分别为**外置ADC128S102（SPI）**与**ESP32S3内置ADC**，应封装为两个派生类，如`ExternalAdc128s102`和`InternalAdcEsp32`。  
   - 要求便于后续扩展更多ADC实现，只需继承同一基类/接口即可。

4. **兼容现有流程**  
   - `main.c`初始化序列、`system_monitor.c`读取流程、BLE通知等功能需要迁移到新的C++接口下，保持现有行为和日志格式。  
   - 校准、批量读取、BLE通知等功能如仍需要，需在新架构下保留或提供等价实现。

## 待确认问题
- “两种ADC代码”具体指的是哪两套实现（例如真实硬件驱动 + 某个模拟/测试实现）？请提供当前备用代码所在文件或命名以便映射到类。
- 自适应传感器数量是否需要运行时动态检测，还是由编译期配置 / `hardware_defs` 中的宏常量提供？若存在新的传感器布局，请说明。

请确认或补充以上需求，如需调整请告知。确认后我会继续进入设计阶段。
