# 蓝牙控制协议文档

## 概述

本文档描述了ESP32PowerHub项目实现的蓝牙低功耗(BLE)控制协议。该协议基于Apache Nimble BLE栈实现，提供PWM通道控制和电源管理功能。

## 基础架构

- **蓝牙栈**: Apache Nimble BLE
- **设备名称**: "PowerHub"
- **服务UUID**: `119B5F1B-1C7A-3E8E-6147-672F-0100-0B5E` (自定义128位UUID)
- **连接模式**: 支持单设备连接
- **广告模式**: 可发现，不可连接

## GATT服务定义

### 主要服务
自定义服务包含4个特征，分别负责状态监控、通道控制、电源管理配置和实时监控数据。

### GATT特征详细说明

#### 1. 通道状态特征 (UUID: 0xFFF0)

**基本信息**
- **UUID**: `0xFFF0`
- **属性**: 读取 + 通知 (`BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_NOTIFY`)
- **描述**: 读取6个PWM通道的当前状态，支持状态变化实时通知

**读取操作**
- **数据格式**: 6字节数组 `[CH0, CH1, CH2, CH3, CH4, CH5]`
- **每个字节**: 对应一个通道的状态值 (0-255)
- **访问方式**: 通过GATT读取操作获取当前状态

**通知功能**
- **触发条件**: 客户端订阅本特征
- **发送时机**: 仅在通道状态发生变化时发送
- **变化检测**: 系统缓存上次状态，有变化时自动推送
- **数据格式**: 与读取格式相同，6字节数组
- **订阅管理**: 通过BLE_SUBSCRIBE事件管理

#### 2. 通道控制特征 (UUID: 0xFFF1)

**基本信息**
- **UUID**: `0xFFF1`
- **属性**: 只写 + 无响应写入 (`BLE_GATT_CHR_F_WRITE | BLE_GATT_CHR_F_WRITE_NO_RSP`)
- **描述**: 控制PWM通道的行为模式和参数

**命令格式**
- **通用格式**: `[模式(1字节)][通道(1字节)][参数(N字节)]`
- **批量操作**: 支持在单次写入中包含多个命令
- **访问方式**: 通过GATT写入操作发送控制命令

**控制模式详情**
见下方"控制命令协议"章节的完整说明

#### 3. 电源管理特征 (UUID: 0xFFF5)

**基本信息**
- **UUID**: `0xFFF5`
- **属性**: 读/写 + 无响应写入 + 通知 (`BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_WRITE | BLE_GATT_CHR_F_WRITE_NO_RSP | BLE_GATT_CHR_F_NOTIFY`)
- **描述**: 系统电源管理、监控和配置

**读取操作**
- **数据格式**: 16字节数组 (完整系统状态)
- **详细格式**: 见下方"电源管理协议"章节

**写入操作**
- **数据格式**: 3字节命令 `[命令(1字节)][参数(2字节)]`
- **支持的命令**: 阈值设置、强制睡眠/唤醒、温度保护配置
- **详细说明**: 见下方"电源管理协议"章节

#### 3. 电源管理特征 (UUID: 0xFFF5)

**基本信息**
- **UUID**: `0xFFF5`
- **属性**: 读/写 + 无响应写入 (`BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_WRITE | BLE_GATT_CHR_F_WRITE_NO_RSP`)
- **描述**: 系统电源管理配置（移除了实时监控数据）

**读取操作**
- **数据格式**: 8字节数组 (配置参数)
- **详细格式**:
  ```
  偏移   长度   类型      描述
  0      2      int16     高温阈值 (0.01°C)
  2      2      int16     恢复阈值 (0.01°C)
  4      2      uint16    睡眠电压阈值 (mV)
  6      2      uint16    唤醒电压阈值 (mV)
  ```
- **注意**: 状态标志已移至监控特征，此处仅包含配置参数

**写入操作**
- **数据格式**: 3字节命令 `[命令(1字节)][参数(2字节)]`
- **支持的命令**: 阈值设置、强制睡眠/唤醒、温度保护配置
- **详细说明**: 见下方"电源管理协议"章节

#### 4. 实时监控特征 (UUID: 0xFFF6)

**基本信息**
- **UUID**: `0xFFF6`
- **属性**: 读取 + 通知 (`BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_NOTIFY`)
- **描述**: 实时系统监控数据，包含电压、温度和电流信息

**读取操作**
- **数据格式**: 36字节数组 (完整监控数据)
- **详细格式**:
  ```
  偏移   长度   类型      描述
  0      2      uint16    输入电压 (mV)
  2      2      int16     电源区域温度 (0.01°C)
  4      2      int16     控制区域温度 (0.01°C)
  6      4      float     总输入电流 (A, IEEE 754)
  10     24     -         6通道电流数据 (6 x float, A)
  34     1      uint8     系统状态标志
  35     1      -         保留字节
  ```
- **温度数据格式**:
  - 偏移2-3: 电源区域温度传感器读数
  - 偏移4-5: 控制区域温度传感器读数
  - 无效数据标记: 0x8000
- **电流数据格式**: 每个通道电流为4字节IEEE 754浮点数
  - 偏移10-13: CH1电流
  - 偏移14-17: CH2电流
  - ...依此类推
  - 偏移30-33: CH6电流
- **系统状态标志位**:
  - bit0: 热保护激活
  - bit1: 温度数据有效
  - bit2: 电流数据有效
  - bit3: 校准状态
  - bit4: 外设电源开启
  - bit5-7: 保留

**通知功能**
- **触发条件**: 客户端订阅本特征
- **发送频率**: 定时发送（根据ADC采样配置）
- **数据格式**: 与读取格式相同，36字节数组
- **数据源**: 来自ADC128S102外置ADC、两个DS18B20温度传感器和系统状态
- **传感器**:
  - 电源区域：监控电源相关部件温度
  - 控制区域：监控控制电路温度
- **状态监控**: 实时系统状态标志位
- **订阅管理**: 通过BLE_SUBSCRIBE事件管理

## 控制命令协议 (通道控制特征)

### 命令格式
```
[模式(1字节)][通道(1字节)][参数(N字节)]
```

### 控制模式定义

| 模式代码 | 名称 | 参数长度 | 参数格式 | 描述 |
|---------|------|----------|----------|------|
| 0x00 | 设置模式 | 1字节 | 亮度值(0-255) | 立即设置通道亮度 |
| 0x01 | 渐变模式 | 3字节 | 亮度值(1字节) + 持续时间(2字节) | 平滑渐变到指定亮度 |
| 0x02 | 闪烁模式 | 2字节 | 周期时间(2字节) | 按指定周期闪烁 |
| 0x03 | 频闪模式 | 5字节 | 次数(1字节) + 总时间(2字节) + 暂停时间(2字节) | 频闪效果控制 |

### 通道定义
- **通道范围**: 0-5 (对应6个PWM通道)
- **硬件映射**:
  - CH0: GPIO8
  - CH1: GPIO9
  - CH2: GPIO10
  - CH3: GPIO11
  - CH4: GPIO12
  - CH5: GPIO13

### 命令示例
```
// 设置通道0为最大亮度
[0x00][0x00][0xFF]

// 通道1在2秒内渐变到128亮度
[0x01][0x01][0x80][0x00][0x02]

// 通道2以1秒周期闪烁
[0x02][0x02][0x00][0x04]

// 通道3频闪5次，每次持续500ms，间隔200ms
[0x03][0x03][0x05][0x00][0x02][0x00][0xC8]
```

## 电源管理协议 (电源管理特征)

### 读取操作 - 系统状态响应 (16字节)

```
偏移   长度   类型      描述
0      2      uint16    输入电压 (mV)
2      2      int16     当前温度 (0.01°C)
4      2      int16     高温阈值 (0.01°C)
6      2      int16     恢复阈值 (0.01°C)
8      2      uint16    睡眠电压阈值 (mV)
10     2      uint16    唤醒电压阈值 (mV)
12     1      uint8     状态标志
13     3      -         保留字节
```

#### 状态标志位定义 (偏移12)
- **bit0**: 热保护激活 (1=激活)
- **bit1**: 温度数据有效 (1=有效)
- **bit2-7**: 保留位

### 写入操作 - 配置命令 (3字节)

```
[命令(1字节)][参数(2字节, int16, 大端序)]
```

#### 命令定义

| 命令代码 | 名称 | 参数类型 | 描述 |
|---------|------|----------|------|
| 0x01 | 设置睡眠阈值 | uint16 (mV) | 设置系统睡眠电压阈值 |
| 0x02 | 设置唤醒阈值 | uint16 (mV) | 设置系统唤醒电压阈值 |
| 0x03 | 强制睡眠 | - | 立即进入睡眠模式 |
| 0x04 | 强制唤醒 | - | 强制系统唤醒 |
| 0x11 | 设置高温阈值 | int16 (0.01°C) | 设置热保护高温阈值 |
| 0x12 | 设置恢复阈值 | int16 (0.01°C) | 设置热保护恢复阈值 |

### 命令示例
```
// 设置睡眠电压阈值为12.5V
[0x01][0x30][0xD4]

// 设置高温阈分为60.00°C
[0x11][0x17][0x70]

// 强制进入睡眠
[0x03][0x00][0x00]
```

## 连接管理

### 广播配置
- **广播标志**: 可发现，不支持经典蓝牙
- **扫描响应**: 包含设备名称和服务UUID
- **名称截断**: 空间不足时自动截断设备名称

### 连接流程
1. 设备启动后开始广播
2. 客户端连接后停止广播
3. 连接断开后自动重新开始广播
4. LED状态指示连接状态

### MTU协商
- 支持MTU交换以提高数据传输效率
- 默认MTU: 23字节
- 建议MTU: 247字节 (ESP32最大支持)

## 通知机制概览

本协议支持两种通知特征，详细的功能和格式说明已包含在上述对应的GATT特征说明中：

### 通知特征总结

- **CH_STATE (0xFFF0)**: 状态变化触发通知，6字节PWM通道数据
- **CH_MONITORING (0xFFF6)**: 定时通知，36字节完整监控数据（电压+分区温度+电流+状态）
- **CH_POWER_MGMT (0xFFF5)**: 不再支持通知，只用于配置管理

### 通用通知特性
- **订阅管理**: 通过BLE_SUBSCRIBE事件管理
- **连接管理**: 连接断开时自动取消订阅状态
- **错误处理**: 包含完整的mbuf分配和发送错误处理

详细的通知格式和使用方法请参考各自GATT特征的说明。

## 错误处理

### BLE ATT错误代码
| 错误代码 | 含义 | 触发条件 |
|---------|------|----------|
| `BLE_ATT_ERR_INVALID_ATTR_VALUE_LEN` | 无效的属性值长度 | 命令参数长度错误 |
| `BLE_ATT_ERR_INSUFFICIENT_RES` | 资源不足 | 调度器忙碌 |
| `BLE_ATT_ERR_WRITE_NOT_PERMITTED` | 写入不被允许 | 对只读特征执行写入 |
| `BLE_ATT_ERR_READ_NOT_PERMITTED` | 读取不被允许 | 对只写特征执行读取 |
| `BLE_ATT_ERR_REQ_NOT_SUPPORTED` | 请求不被支持 | 不支持的命令代码 |

### 日志级别
- **ERROR**: 严重错误，LED状态指示
- **WARN**: 警告信息，不影响功能
- **INFO**: 一般信息，连接和状态变化
- **DEBUG**: 调试信息，详细的协议交互

## 实现细节

### 文件结构
- `ble_server.c/h`: BLE服务器主要实现
- `command_codec.c/h`: 命令编解码
- `control_types.h`: 控制命令数据结构
- `power_mgr.c/h`: 电源管理功能

### 关键函数
- `ble_server_init()`: 初始化BLE服务器
- `chr_control_access()`: 处理控制命令写入
- `chr_state_access()`: 处理状态读取
- `power_mgr_ble_access()`: 处理电源管理访问

### 性能考虑
- **命令处理**: 200ms超时的异步处理机制
- **内存管理**: 固定大小缓冲区，避免动态分配
- **并发控制**: 通过调度器串行化命令执行

## 版本历史

- **v1.0**: 基础BLE服务，6通道PWM控制
- **v1.1**: 添加电源管理特征和通知功能
- **v1.2**: 扩展温度保护和阈值配置
- **v1.3**: 添加通道状态变化通知功能
- **v1.4**: 重构特征结构，添加实时监控特征（0xFFF6）支持电流数据
- **v1.5**: 增强监控特征，支持分区温度监控（电源区域+控制区域）
- **v1.6**: 整合状态监控，将系统状态标志移动到监控特征
- **当前版本**: 支持完整的电源管理配置、分区温度监控、实时电流监控和状态监控

## 开发指南

### 客户端开发最佳实践

**初始化流程**
1. **连接建立**: 连接到"PowerHub"设备
2. **服务发现**: 发现自定义服务 (UUID: `119B5F1B-1C7A-3E8E-6147-672F-0100-0B5E`)
3. **特征发现**: 识别3个主要特征及其句柄
4. **状态读取**: 读取各特征值获取当前系统状态
5. **订阅设置**: 根据需要订阅通知特征

**通知订阅策略**
- **CH_STATE (0xFFF0)**: 订阅以接收实时PWM状态变化
- **CH_MONITORING (0xFFF6)**: 订阅以接收周期性系统监控数据（电压+分区温度+电流）
- **CH_POWER_MGMT (0xFFF5)**: 不再支持通知，使用读取操作获取配置

**命令发送优化**
- 使用无响应写入 (`write without response`) 提高控制命令发送效率
- 实现MTU交换以优化数据传输性能
- 在单次写入中组合多个控制命令

**数据处理注意事项**
- **通知数据验证**: 检查数据长度和格式
- **CH_STATE通知**: 6字节，对应6个PWM通道状态
- **CH_MONITORING通知**: 36字节，包含电压、分区温度、电流和状态数据
- **特征区分**: 通过特征句柄或数据长度识别通知来源
- **浮点数据处理**: 监控特征中的电流数据为IEEE 754浮点格式，需要正确解析
- **分区温度**: 提供两个独立区域的温度监控，便于热管理和故障诊断
- **状态标志**: 实时系统状态监控，包含热保护、数据有效性、校准状态等信息
- **状态位解析**: 需要正确解析8位状态标志的各个位含义

**错误处理和恢复**
- 实现BLE ATT错误码的处理逻辑
- 添加连接断开检测和自动重连机制
- 处理订阅状态丢失的情况

### 测试验证清单

**基础功能测试**
- [ ] 验证设备发现和连接建立
- [ ] 测试服务发现和特征识别
- [ ] 验证各特征的读取操作
- [ ] 测试控制命令的写入操作

**通知功能测试**
- [ ] 验证CH_STATE状态变化通知的准确性
- [ ] 测试CH_MONITORING定时通知的频率和格式
- [ ] 验证监控特征中电流数据的准确性
- [ ] 测试浮点数据的IEEE 754格式解析
- [ ] 验证分区温度数据的准确性和独立性
- [ ] 测试温度传感器故障时的错误处理
- [ ] 验证状态标志位的正确性和实时性
- [ ] 测试热保护激活时状态标志的变化
- [ ] 验证外设电源状态标志的准确性
- [ ] 验证数据有效性标志的正确性
- [ ] 验证订阅和取消订阅功能
- [ ] 测试连接断开时的订阅状态清理
- [ ] 验证电源管理特征不再发送状态标志

**边界条件测试**
- [ ] 测试各种控制命令格式的边界条件
- [ ] 验证参数范围检查和错误处理
- [ ] 测试高频控制命令下的系统稳定性
- [ ] 验证多客户端连接时的通知隔离

**性能和稳定性测试**
- [ ] 测试长时间连接的稳定性
- [ ] 验证高频通知对系统性能的影响
- [ ] 测试网络条件不佳时的重连机制
- [ ] 验证内存使用和资源清理

### 调试工具
- **nRF Connect**: 移动端BLE调试工具
- **Wireshark**: 配合BLE嗅探器进行协议分析
- **ESP_LOG**: 启用详细日志进行内部调试