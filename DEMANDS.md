# 原始需求和部分设计

## 持久化
使用NVS Flash存储状态数据，并在上电时立即恢复。
需要保存的数据有：
- 4个PWM通道的占空比值（0-255）
- 预设数据

## BLE通讯设计
### 数据结构
字节序为BE

#### 开关状态
每路通道使用1字节无符号整数表示，0表示关闭（GPIO高阻），255表示开启（GPIO高电平），其他值表示占空比（value / 255）

#### 通道控制
控制指令由至少2字节的不定长数据表示，第一字节为模式，第二字节为通道号（0-3）；第三字节起为模式参数；指令表如下：

|模式|说明|参数说明|
|---|---|---|
|0x00|设置值|1字节无符号整数，表示要为通道设置的值|
|0x01|渐变|第一个参数为1字节无符号整数，表示要为通道设置的值；第二个参数为2字节无符号整数，表示渐变时长，单位毫秒|
|0x02|等速闪烁|2字节无符号整数，表示闪烁周期|
|0x03|爆闪|第一个参数为1字节无符号整数，表示点亮次数；第二个参数为2字节无符号整数，表示总闪烁时长，单位毫秒，闪烁周期为总时长/点亮次数（50%占空，ON=周期/2，OFF=周期/2）；第三个参数为2字节无符号整数，表示停顿时长，单位毫秒，为0时表示完成一组闪烁就关闭|

### Characteristic设计
#### 0xFFF0 PWM通道状态
工作在READ模式，返回4个单字节无符号整数，分别表示第1到第4个PWM通道的开关状态

#### 0xFFF1 控制指令
工作在WRITE模式，用于接收来自控制端的控制指令

#### 0xFFF2 读取预设数据
工作在READ模式，返回全部预设数据

#### 0xFFF3 写入预设数据
工作在WRITE模式，写入指定编号的预设数据
0x00编号为保留编号，不允许写入

单个预设的数据结构如下
|长度|内容|含义|
|---|---|---|
|1字节|无符号整数|预设编号|
|1字节|无符号整数|控制指令数量|
|不定长|连续的N条控制指令|预设包含的控制指令|

每次只允许写入一个预设，预设包含的控制指令数量为0时表示删除该预设

#### 0xFFF4 执行预设
工作在WRITE模式，接收1字节无符号整数，表示要执行的预设编号，收到指令后执行指定预设中包含的全部控制指令。
0x00编号为保留编号，表示关闭所有通道。