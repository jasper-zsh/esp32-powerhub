# ESP32 Power Hub 设计文档

## 1. 目标与范围
- 通过 BLE 接口控制 4 路 PWM 通道（GPIO7/8/9/10），支持开关、PWM、渐变、闪烁、爆闪和预设执行。
- 所有通道状态与预设数据需持久化到 NVS，在上电初始化阶段立即恢复。
- 设计基于 ESP32S3 和 ESP-IDF，保证与 `idf.py` 构建流程兼容。

## 2. 系统总览
- **硬件资源**：4 路 PWM 通道复用 LEDC 外设高分辨率定时器，GPIO7-10 为输出（默认关闭，高阻态）。
- **软件组件**：
  - `app_main`：完成系统初始化、恢复持久化数据、启动任务。
  - `pwm_ctrl`：封装 LEDC 驱动初始化、占空比设置以及模式调度。
  - `preset_mgr`：管理预设数据的 NVS 存取与解析。
  - `ble_srv`：负责 GATT Server、Characteristic 定义与指令收发。
  - `scheduler`：驱动渐变/闪烁等时间相关模式的实时调度。
- **数据流**：
  1. BLE 写入指令到 0xFFF1。
  2. `ble_srv` 解析为命令结构体，转交 `scheduler` 或 `pwm_ctrl`。
  3. `scheduler` 根据模式生成 PWM 更新事件，调用 `pwm_ctrl` 执行。
  4. 状态变化写回 NVS；最新通道状态由 0xFFF0 Characteristic 提供。
  5. 预设管理通过 0xFFF2/0xFFF3 实现读写，通过 0xFFF4 触发执行。

## 3. 持久化设计
- **NVS 命名空间**：`powerhub`。
- **键值规划**：
  - `ch_state`: 4 字节数组，保存每路通道的当前值（0-255）。
  - `preset_cnt`: 1 字节，记录预设数量（可选，用于快速遍历）。
  - `preset_<id>`：二进制块，存储单个预设数据；键名格式 `preset_%02X`（仅对 id ≠ 0x00 生效）。
- **启动流程**：
  1. 初始化 NVS（必要时擦除并重启）。
  2. 读取 `ch_state`，若缺失则默认 0。
  3. 逐通道调用 `pwm_ctrl` 设置占空比，保证上电即恢复状态。
- **更新策略**：
  - 通道值变化后立即写回 `ch_state`。
  - 预设写入/删除后同步更新对应键；命令数量为 0 时删除 `preset_<id>` 键；错误时返回 BLE 错误码。

## 4. PWM 控制设计
- **LEDC 配置**：
  - 选择高速模式，13-bit 分辨率满足 0-255 占空比映射。
  - 全部通道共用一个定时器，频率根据负载需求设定（默认 5 kHz）。
- **通道模式**：
  - `SWITCH`：0 = 关闭（GPIO 置为高阻/LEDC 停用），255 = 打开（GPIO 输出高电平，100% 占空）。
  - `PWM`：1-254 映射到 LEDC 占空比 = value/255 * 2^13，保持需求中 value/255 的占空比语义。
  - `TRANSITION`：渐变模式由 `scheduler` 改变占空比。
  - `BLINK` / `STROBE`：定时任务在 ON/OFF 之间切换占空比。
- **接口**：
  - `pwm_ctrl_set(channel, value)`：立即设置通道值并更新 NVS。
  - `pwm_ctrl_apply(channel, duty_raw)`：内部函数，实现硬件写入。
  - `pwm_ctrl_stop(channel)`：停止非静态模式时调用。

## 5. 调度与模式实现
- **任务模型**：
  - 创建 `scheduler` 任务（优先级中等），使用 FreeRTOS 队列接收模式命令。
  - 队列元素包含通道号、目标模式、参数以及开始时间。
- **渐变 (0x01)**：
  - 记录起始值、目标值与持续时间；通过定时器或 Tick 计算每个刷新周期的占空比，确保线性渐变。
- **等速闪烁 (0x02)**：
  - 周期参数表示整个高低电平周期；50% 占空，交替调用 `pwm_ctrl_set`。
- **爆闪 (0x03)**：
  - 计算单次闪烁周期 = 总时长 / 点亮次数。
  - 生成爆闪序列后可附加停顿阶段（参数 3，为毫秒）。
- **预设执行**：
  - `preset_mgr` 解析预设指令序列并依次提交给 `scheduler`。
  - 支持串行执行；若需并行同通道指令，后发指令覆盖前一条。
  - 通过 0xFFF4 接口触发；编号 0x00 时先中断所有通道模式并设置为 0。
- **模式中断**：
  - 新指令发送到同一通道时，先调用 `pwm_ctrl_stop` 中断当前模式。

## 6. BLE 服务设计
- **GATT 结构**：
  - Service UUID：自定义，包含五个 Characteristic。
  - `0xFFF0`（READ）：调用 `pwm_ctrl_get_state` 返回 4 字节值，顺序对应通道 1-4。
  - `0xFFF1`（WRITE）：接收控制指令；解析失败时返回 `ESP_GATT_INVALID_ATTR_LEN` 或 `ESP_GATT_INVALID_PDU`。
  - `0xFFF2`（READ）：序列化全部预设数据，以 [预设条目]×N 形式拼接。
  - `0xFFF3`（WRITE）：写入单个预设并立即持久化；预设编号 0x00 为保留编号，拒绝写入。
  - `0xFFF4`（WRITE）：接收 1 字节预设编号，0x00 表示关闭全部通道，其他值触发对应预设执行。
- **安全/配对**：保留默认安全级别，若未来需要可启用加密。
- **数据校验**：
  - 控制指令：检查长度、模式和通道号范围。
  - 预设写入：验证指令数量是否匹配实际解析出的条目。

## 7. 数据结构与序列化
- **控制指令结构**：
  ```c
  typedef struct {
      uint8_t mode;      // 0x00 - 0x03
      uint8_t channel;   // 0-3
      uint8_t payload[6];// 最大参数长度
      uint8_t length;    // payload 实际长度
  } control_cmd_t;
  ```
- **模式参数约定**：
  - 0x00（设置值）：1 字节目标值，0 表示关闭（GPIO 高阻），255 表示全开，其他值按 value/255 的占空比执行。
  - 0x01（渐变）：
    - Byte2：目标值（1 字节）。
    - Byte3-4：渐变时长（2 字节无符号整数，毫秒，大端）。
  - 0x02（等速闪烁）：
    - Byte2-3：闪烁周期（2 字节无符号整数，毫秒，大端）。
  - 0x03（爆闪）：
    - Byte2：点亮次数（1 字节）。
    - Byte3-4：总闪烁时长（2 字节，无符号毫秒，大端）。
    - Byte5-6：停顿时长（2 字节，无符号毫秒，大端），0 表示完成一组闪烁后立即关闭。
- **预设条目**：
  ```c
  typedef struct {
      uint8_t id;
      uint8_t cmd_count;
      control_cmd_t cmds[MAX_CMDS];
  } preset_t;
  ```
- **序列化规则**：
  - 大端字节序，与需求保持一致。
  - 预设条目格式：编号（1 字节）、命令数量（1 字节）、连续的 N 条控制指令（二进制封装）。
  - 预设写入时命令数量为 0 表示删除该编号，`preset_mgr` 需同步移除对应 NVS 键。
  - `preset_mgr` 在读写时维护缓冲区，确保 0xFFF2 输出连续的预设块。

## 8. 错误处理与回退
- BLE 指令解析失败或参数非法时，返回对应 GATT 错误，并且不修改状态。
- NVS 写入失败时记录日志并返回错误码；必要时提示清理 NVS。
- Scheduler 发生异常（队列满）时丢弃最旧命令并报警。

## 9. 日志与调试
- 使用 ESP-IDF 日志模块，tag 按组件划分：`PWM`, `BLE`, `PRESET`, `SCHED`。
- 在调试构建中启用 debug 等级；生产构建只保留 warning 级别及以上。

## 10. 测试计划
- **单元测试**：对指令解析、预设序列化等逻辑使用 Unity 框架测试。
- **集成测试**：通过 BLE 测试脚本验证各 Characteristic 功能。
- **硬件测试**：实机验证 4 路输出的占空比、渐变和闪烁模式。

## 11. 后续扩展
- 支持按组控制通道的广播指令。
- 增加 BLE 通知，实时推送通道状态变化。
- 扩展更多预设参数（如循环次数、渐变曲线）。
